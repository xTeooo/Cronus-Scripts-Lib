int toggle, fight;
int HW_loop, killed, loop_cycle;
int elevator, combat, no_combat, dead;

const string TXT[] = {
			"L2/LT + UP"   , "to start or stop" ,
			//   0                 1    
			"The Summit"   , "AutoFarm"  ,
			//   2               3
			"Go to cover"  , "HardWired loop"  ,  "Suicide" , "You're dead" , "Restart"
			//   4                  5                  6            7             8
}

int display_info, info_timer, current_info;
int display_black, count_black;
int display_main = 1;

main {
	set_val(TRACE_1, toggle);
	set_val(TRACE_2, fight);
	set_val(TRACE_3, HW_loop);
	set_val(TRACE_4, killed);
	set_val(TRACE_5, loop_cycle);
	set_val(TRACE_6, count_black / 1000);
	
// Block controller rumbles
	block_rumble();
	
// Colors definitions	
	elevator = get_led(LED_1) == 0x02 && get_led(LED_2) == 0x0D && get_led(LED_3) == 0x02;
	combat = !get_led(LED_1) && get_led(LED_2) == 0xFF && !get_led(LED_3); /*|| !get_led(LED_1) && !get_led(LED_2) && get_led(LED_3) == 0xFF*/
	no_combat = !get_led(LED_1) && get_led(LED_2) == 0xFF && get_led(LED_3) == 0x37;
	dead = !get_led(LED_1) && get_led(LED_2) == 0x0D && !get_led(LED_3);

// Toggle
	if(get_val(PS4_L2) && event_press(PS4_UP))
	{
		toggle = !toggle;
		
		if(!toggle)
			display_main = TRUE;
	}

// Toggle ON
	if(toggle)
	{
		if(!HW_loop)
		{
			if(elevator)
				combo_run(GO_TO_COVER_AND_START_CYCLE);
		}
		else 
		{	
			if(combat) 
				fight = TRUE;
				
			if(fight)
				combo_run(HARD_WIRED);
			else
				combo_stop(HARD_WIRED);
			
			if(no_combat && !killed) 
				combo_run(NADE);
				
			if(dead) 
				combo_run(RESTART);	
		}
	}
// Toggle OFF	
	else
	{
		combo_stop_all();
		HW_loop = 0;
		loop_cycle = 0;
		killed = 0
	}



	
// Screen Saver	
	if(display_black)
	{
	// Timer to display user infos
		info_timer += get_rtime();
		if(info_timer > 2000)
		{
			current_info = !current_info;
			display_info = TRUE;
		}
		
		count_black += get_rtime();
		if(count_black >= 150000) // 2min 30sec
		{
			cls_oled(OLED_BLACK);
			count_black = 0;
			display_black = FALSE;
		}
	}

// Display how to toggle
	if(display_info) 
	{
		info_timer = 0;
		rect_oled(1, 50, 126, 13, OLED_WHITE, OLED_BLACK); // bottom rectangle (clear)
		print(center_x(get_string_length(TXT[current_info]), OLED_FONT_SMALL_WIDTH),53,OLED_FONT_SMALL,OLED_WHITE,TXT[current_info]);
		display_info = FALSE;
	}

// Display script name
	if(display_main)
	{
		cls_oled(OLED_BLACK);
		print(center_x(get_string_length(TXT[2]), OLED_FONT_MEDIUM_WIDTH),4,OLED_FONT_MEDIUM,OLED_WHITE,TXT[2]);
		print(center_x(get_string_length(TXT[3]), OLED_FONT_MEDIUM_WIDTH),26,OLED_FONT_MEDIUM,OLED_WHITE,TXT[3]);
		display_info = TRUE;
		display_black = TRUE;	
		display_main = FALSE;
	}
}

combo GO_TO_COVER_AND_START_CYCLE {	
	if(display_black)
	{
	// Display "Go to cover"
		rect_oled(1, 1, 126, 49, OLED_WHITE, OLED_BLACK); // clear text zone
		print(center_x(get_string_length(TXT[4]), OLED_FONT_SMALL_WIDTH),random(1, 36),OLED_FONT_SMALL,OLED_WHITE,TXT[4]);
		count_black = 0; // reset screensaver coundown
	}
	wait(get_rtime());
	
// Start running to the cover	
	set_val(PS4_LY, -100);
	wait(390);
	set_val(PS4_L3, 100);
	set_val(PS4_LY, -100);
	wait(3160);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 23);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 59);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 82);
	set_val(PS4_LY, -84);
	wait(1190);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 76);
	set_val(PS4_LY, -89);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 57);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 23);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LY, -100);
	wait(310);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 49);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 81);
	set_val(PS4_LY, -85);
	wait(410);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 67);
	set_val(PS4_LY, -96);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 38);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LY, -100);
	wait(160);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 54);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 82);
	set_val(PS4_LY, -84);
	wait(510);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 48);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 23);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LY, -100);
	wait(790);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 48);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 82);
	set_val(PS4_LY, -84);
	wait(230);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 40);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LY, -100);
	wait(540);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 32);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 79);
	set_val(PS4_LY, -86);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 83);
	set_val(PS4_LY, -83);
	wait(550);
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 66);
	set_val(PS4_LY, -97);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LX, 33);
	set_val(PS4_LY, -100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_L3, 100);
	set_val(PS4_LY, -100);
	wait(770);
	set_val(PS4_L3, 100);
	set_val(PS4_LY, -100);
	set_val(PS4_CROSS, 100);
	wait(80);
	set_val(PS4_LY, -74);
	set_val(PS4_CROSS, 100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_LY, -49);
	set_val(PS4_CROSS, 100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_LY, -30);
	set_val(PS4_CROSS, 100);
	wait(10); //_________________________________________________________________________________________
	set_val(PS4_CROSS, 100);
	wait(720);
	
// Start Cycle 
	set_val(PS4_R1, 100); // seeker
	wait(700);
	wait(2200);
	set_val(PS4_L1, 100); // turet on
	wait(100);
	wait(4200);

	loop_cycle++;
	HW_loop++;
}

combo HARD_WIRED { // HardWired loop
	if(display_black)
	{
// Display "HardWired loop"
	rect_oled(1, 1, 126, 49, OLED_WHITE, OLED_BLACK); // clear text zone
	print(center_x(get_string_length(TXT[5]), OLED_FONT_SMALL_WIDTH),random(1, 36),OLED_FONT_SMALL,OLED_WHITE,TXT[5]);
	}
	wait(get_rtime());
	
// Start loop
	set_val(PS4_L1, 100); // turet off
	wait(900);
	wait(1750);
	set_val(PS4_L1, 100); // turet on
	wait(150);
	wait(1000);
	set_val(PS4_R1, 100); // seeker
	wait(700);
	wait(3250);
	set_val(PS4_R1, 100);
	wait(200);
	wait(3250);
	
	loop_cycle++;
}

combo NADE {
	fight = FALSE;
	if(display_black)
	{
	// Display "Suicide"
		rect_oled(1, 1, 126, 49, OLED_WHITE, OLED_BLACK); // clear text zone
		print(center_x(get_string_length(TXT[6]), OLED_FONT_SMALL_WIDTH),random(1, 36),OLED_FONT_SMALL,OLED_WHITE,TXT[6]);
	}
	wait(get_rtime());
	
	//wait(1000);
	set_val(PS4_LEFT, 100); // take nade
	wait(100);

	set_val(PS4_RY, 100); // change view
	set_val(PS4_RX, 100); // change view
	wait(1000);

	set_val(PS4_R2, 100); // throw nade
	wait(100);

	set_val(PS4_LY, -100); // go forward
	wait(500);
	
	wait(4000);
	if(get_led(LED_2) == 0x0D)
		killed = 1;
	
}

combo RESTART {
	fight = FALSE;
	if(display_black)
	{
	// Display "You're dead"
		rect_oled(1, 1, 126, 49, OLED_WHITE, OLED_BLACK); // clear text zone
		print(center_x(get_string_length(TXT[7]), OLED_FONT_SMALL_WIDTH),random(1, 36),OLED_FONT_SMALL,OLED_WHITE,TXT[7]);
	}
	wait(get_rtime());
		
	wait(3500); // wait respawn
	set_val(PS4_SQUARE, 100); // press respawn
	wait(150);
	
	if(display_black)
	{
	// Display "Restart"
		rect_oled(1, 1, 126, 49, OLED_WHITE, OLED_BLACK); // clear text zone
		print(center_x(get_string_length(TXT[8]), OLED_FONT_SMALL_WIDTH),random(1, 36),OLED_FONT_SMALL,OLED_WHITE,TXT[8]);
	}
	wait(get_rtime());
		
	wait(8000); // loading + elevator
	display_main = TRUE;
	wait(get_rtime());
	wait(2000);
	
	killed = 0;
	HW_loop = 0;
	loop_cycle = 0;
}

int stringLength;
function get_string_length(offset) { // by Swizzy

    stringLength = 0;
    while (duint8(offset++)) { stringLength++; }
    return stringLength + 1;
}

function center_x(f_chars,f_font) {

    return (OLED_WIDTH / 2) - ((f_chars * f_font) / 2);
} ˙ªè∂Ç∫ã≤Ç≥Å∏èºçœ